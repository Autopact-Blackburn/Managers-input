<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manager Daily Input</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Supabase CDN (DO NOT CREATE A VARIABLE NAMED supabase) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --bg: #080b16;
    --card: #111827;
    --text: #e7eaf1;
    --muted: #9ba3b5;
    --accent: #00c2ff;
    --danger: #ff5252;
    --success: #22c55e;
    --border: #1e2638;
  }

  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 40px;
  }

  .container {
    max-width: 540px;
    margin: 20px auto;
    padding: 20px;
    background: var(--card);
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  h2 {
    text-align: center;
    margin-bottom: 20px;
    color: var(--accent);
  }

  label {
    font-size: 14px;
    color: var(--muted);
  }

  .hint {
    font-size: 12px;
    color: #7f8bb3;
    margin-top: -10px;
    margin-bottom: 14px;
  }

  select, input {
    width: 100%;
    padding: 12px;
    margin: 10px 0 6px;
    background: #0b1120;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 15px;
  }

  .btn {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    background: var(--accent);
    color: #000;
    margin-top: 12px;
  }

  .success, .error {
    margin-top: 16px;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    display: none;
    font-weight: 600;
  }

  .success { background: var(--success); color: #000; }
  .error { background: var(--danger); color: #fff; }
</style>
</head>

<body>

<div class="container">
  <h2>Manager Daily Entry</h2>

  <label>Select Your Department</label>
  <select id="departmentSelect">
    <optgroup label="Sales Departments">
      <option>Blackburn Kia</option>
      <option>Blackburn Nissan</option>
      <option>Blackburn GWM</option>
      <option>Blackburn Used</option>

      <option>Burwood Nissan</option>
      <option>Burwood XPENG</option>
      <option>Burwood GWM</option>
      <option>Burwood Used</option>

      <option>FTG Kia</option>
      <option>FTG Hyundai</option>
      <option>FTG Used</option>

      <option>Knox Geely New</option>
      <option>Knox Geely Used</option>

      <option>Knox Mitsubishi New</option>
      <option>Knox Mitsubishi Used</option>

      <option>Lilydale Kia</option>
      <option>Lilydale SsangYong</option>
      <option>Lilydale GMSV</option>
      <option>Lilydale Used</option>
    </optgroup>

    <optgroup label="Service Departments">
      <option>Blackburn Service</option>
      <option>Burwood Service</option>
      <option>FTG Service</option>
      <option>Knox Geely Service</option>
      <option>Knox Mitsubishi Service</option>
      <option>Lilydale Service</option>
      <option>Wollongong Service</option>
    </optgroup>
  </select>

  <div id="formArea"></div>

  <button class="btn" id="submitBtn">Submit</button>

  <div class="success" id="successMsg">✔ Submitted Successfully!</div>
  <div class="error" id="errorMsg">⚠ Something went wrong. Try again.</div>
</div>

<script>
/* =====================================================
   SUPABASE CLIENT (SINGLE SOURCE OF TRUTH)
   ===================================================== */

const sb = window.supabase.createClient(
  "https://ecldmrzlfexinvyyilpi.supabase.co",
  "sb_publishable_8E6BQ2E2-uNz2O3W9TqdQQ_aOC_GXVz"
);

/* =====================================================
   DOM
   ===================================================== */

const departmentSelect = document.getElementById("departmentSelect");
const formArea = document.getElementById("formArea");
const successMsg = document.getElementById("successMsg");
const errorMsg = document.getElementById("errorMsg");

const isServiceDepartment = dept =>
  dept.toLowerCase().includes("service");

const numberInput = id => `
  <input type="number" id="${id}" step="1" min="0" inputmode="numeric">
  <div class="hint">Enter whole numbers only (no decimals or commas)</div>
`;

function renderForm() {
  const dept = departmentSelect.value;
  formArea.innerHTML = "";

  if (isServiceDepartment(dept)) {
    formArea.innerHTML = `
      <label>Customer ROs Closed Today</label>
      ${numberInput("custRos")}

      <label>Warranty ROs Closed Today</label>
      ${numberInput("warrRos")}

      <label>Invoiced Not Closed Remaining</label>
      ${numberInput("invRemain")}

      <label>Gross Today ($)</label>
      ${numberInput("grossToday")}
    `;
  } else {
    formArea.innerHTML = `
      <label>Leads Today</label>
      ${numberInput("leads")}

      <label>Sales Today</label>
      ${numberInput("sales")}
    `;
  }
}

departmentSelect.addEventListener("change", renderForm);
renderForm();

/* =====================================================
   SUBMIT
   ===================================================== */

document.getElementById("submitBtn").addEventListener("click", async () => {
  successMsg.style.display = "none";
  errorMsg.style.display = "none";

  const dept = departmentSelect.value;
  const today = new Date().toISOString().split("T")[0];

  try {
    if (isServiceDepartment(dept)) {
      const payload = {
        date: today,
        site: dept,
        customer_ros: +document.getElementById("custRos").value || 0,
        warranty_ros_today: +document.getElementById("warrRos").value || 0,
        invoiced_remaining: +document.getElementById("invRemain").value || 0,
        gross_today: +document.getElementById("grossToday").value || 0,
        target_gross: 0,
        working_days: 22
      };

      const { error } = await sb
        .from("service_reports")
        .insert([payload]);

      if (error) throw error;

    } else {
      const location = dept.split(" ")[0];

      const { error } = await sb
        .from("sales_reports")
        .insert([{
          date: today,
          location,
          department: dept,
          leads: +document.getElementById("leads").value || 0,
          sales: +document.getElementById("sales").value || 0
        }]);

      if (error) throw error;
    }

    successMsg.style.display = "block";

  } catch (err) {
    console.error(err);
    errorMsg.style.display = "block";
  }
});
</script>

</body>
</html>
